"use strict";(()=>{var e={};e.id=949,e.ids=[949],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6797:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>y,patchFetch:()=>x,requestAsyncStorage:()=>w,routeModule:()=>h,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var r={};i.r(r),i.d(r,{GET:()=>p,PUT:()=>m,dynamic:()=>c});var s=i(79182),a=i(72007),n=i(56719),o=i(93442),d=i(57978),l=i(11826),u=i(83178);let c="force-dynamic";async function p(e){try{let e=await (0,d.getServerSession)(l.L);if(!e?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let t=await u._.user.findUnique({where:{id:e.user.id},include:{backupCodes:{select:{used:!0}}}});if(!t)return o.NextResponse.json({error:"User not found"},{status:404});let i=!!t.emailVerified,r=!!t.phoneVerified,s=t.twoFaEnabled,a=t.backupCodes.length>0,n="complete";i?r?s||(n="2fa"):n="phone":n="email";let c={emailVerified:i,phoneVerified:r,twoFaEnabled:s,backupCodesGenerated:a,verificationStep:n},p={id:t.id,name:t.name,email:t.email,phone:t.phone,emailVerified:t.emailVerified,phoneVerified:t.phoneVerified,twoFaEnabled:t.twoFaEnabled,isActive:t.isActive,loginAttempts:t.loginAttempts,lockedUntil:t.lockedUntil,createdAt:t.createdAt,updatedAt:t.updatedAt};return o.NextResponse.json({user:p,security:c,backupCodesCount:{total:t.backupCodes.length,used:t.backupCodes.filter(e=>e.used).length,remaining:t.backupCodes.filter(e=>!e.used).length}},{status:200})}catch(e){return console.error("Get security settings error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function m(e){try{let t=await (0,d.getServerSession)(l.L);if(!t?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{name:i,phone:r}=await e.json(),s={};if(void 0!==i&&(s.name=i),void 0!==r){if(r&&!/^\+[1-9]\d{1,14}$/.test(r))return o.NextResponse.json({error:"Invalid phone number format. Please include country code (e.g., +1234567890)"},{status:400});if(r&&await u._.user.findFirst({where:{phone:r,id:{not:t.user.id}}}))return o.NextResponse.json({error:"This phone number is already associated with another account"},{status:400});s.phone=r;let e=await u._.user.findUnique({where:{id:t.user.id}});e?.phone!==r&&(s.phoneVerified=null)}if(0===Object.keys(s).length)return o.NextResponse.json({error:"No valid fields to update"},{status:400});let a=await u._.user.update({where:{id:t.user.id},data:s,select:{id:!0,name:!0,email:!0,phone:!0,emailVerified:!0,phoneVerified:!0,twoFaEnabled:!0,isActive:!0,updatedAt:!0}});return o.NextResponse.json({success:!0,message:"Profile updated successfully",user:a},{status:200})}catch(e){return console.error("Update profile error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/security/settings/route",pathname:"/api/security/settings",filename:"route",bundlePath:"app/api/security/settings/route"},resolvedPagePath:"/home/ubuntu/naggery_app/app/app/api/security/settings/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:f,serverHooks:g}=h,y="/api/security/settings/route";function x(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},11826:(e,t,i)=>{i.d(t,{L:()=>l});var r=i(66291),s=i(64617),a=i(83178),n=i(3390),o=i.n(n),d=i(35229);let l={adapter:(0,s.N)(a._),providers:[(0,r.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"},twoFaCode:{label:"2FA Code",type:"text"},backupCode:{label:"Backup Code",type:"text"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email and password are required");if(!(await d.p.checkLoginAttempts(e.email)).allowed)throw Error("Too many login attempts. Please try again later.");let t=await a._.user.findUnique({where:{email:e.email}});if(!t)throw Error("Invalid email or password");if(t.lockedUntil&&t.lockedUntil>new Date){let e=Math.ceil((t.lockedUntil.getTime()-Date.now())/6e4);throw Error(`Account is locked. Try again in ${e} minutes.`)}if(!await o().compare(e.password,t.password))throw await a._.user.update({where:{id:t.id},data:{loginAttempts:t.loginAttempts+1,lockedUntil:t.loginAttempts>=4?new Date(Date.now()+9e5):null}}),Error("Invalid email or password");if(!t.emailVerified)throw Error("Please verify your email address before logging in. Check your inbox for the verification link.");if(!t.isActive)throw Error("Your account is not active. Please contact support.");if(t.twoFaEnabled){let{twoFaCode:i,backupCode:r}=e;if(!i&&!r)return{id:t.id,email:t.email,name:t.name,phone:t.phone,emailVerified:!!t.emailVerified,phoneVerified:!!t.phoneVerified,twoFaEnabled:t.twoFaEnabled,isActive:t.isActive,requiresTwoFa:!0}}return t.loginAttempts>0&&await a._.user.update({where:{id:t.id},data:{loginAttempts:0,lockedUntil:null}}),{id:t.id,email:t.email,name:t.name,phone:t.phone,emailVerified:!!t.emailVerified,phoneVerified:!!t.phoneVerified,twoFaEnabled:t.twoFaEnabled,isActive:t.isActive,requiresTwoFa:!1}}})],session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/login"},callbacks:{jwt:async({token:e,user:t,trigger:i,session:r})=>(t&&(e.id=t.id,e.emailVerified=!!t.emailVerified,e.phoneVerified=!!t.phoneVerified,e.twoFaEnabled=!!t.twoFaEnabled,e.isActive=!!t.isActive,e.requiresTwoFa=!!t.requiresTwoFa),"update"===i&&r&&(e={...e,...r}),e),session:async({session:e,token:t})=>(t&&e.user&&(e.user.id=t.id,e.user.emailVerified=!!t.emailVerified,e.user.phoneVerified=!!t.phoneVerified,e.user.twoFaEnabled=!!t.twoFaEnabled,e.user.isActive=!!t.isActive,e.user.requiresTwoFa=!!t.requiresTwoFa),e)},events:{async signIn({user:e,account:t,profile:i,isNewUser:r}){console.log("User signed in:",{userId:e.id,email:e.email,isNewUser:r})},async signOut({session:e,token:t}){console.log("User signed out:",{userId:t?.id})}}}},83178:(e,t,i)=>{i.d(t,{_:()=>s});var r=i(53524);let s=globalThis.prisma??new r.PrismaClient},35229:(e,t,i)=>{i.d(t,{p:()=>a});var r=i(39103),s=i.n(r);class a{constructor(){this.defaultOptions={windowMs:9e5,maxAttempts:5,message:"Too many attempts, please try again later"},this.cache=new(s())({stdTTL:this.defaultOptions.windowMs/1e3,checkperiod:60})}async checkRateLimit(e,t={}){let i={...this.defaultOptions,...t},r=`rate_limit:${e}`,s=Date.now();i.windowMs;let a=this.cache.get(r)||{count:0,resetTime:s+i.windowMs};s>a.resetTime&&(a={count:0,resetTime:s+i.windowMs}),a.count++;let n=Math.ceil((a.resetTime-s)/1e3);this.cache.set(r,a,n);let o=a.count<=i.maxAttempts;return{allowed:o,remaining:Math.max(0,i.maxAttempts-a.count),resetTime:a.resetTime,message:o?void 0:i.message}}async incrementAttempt(e){await this.checkRateLimit(e)}async resetRateLimit(e){let t=`rate_limit:${e}`;this.cache.del(t)}static async checkLoginAttempts(e){return new a().checkRateLimit(`login:${e}`,{windowMs:9e5,maxAttempts:5,message:"Too many login attempts. Please try again in 15 minutes."})}static async checkVerificationAttempts(e){return new a().checkRateLimit(`verification:${e}`,{windowMs:3e5,maxAttempts:3,message:"Too many verification attempts. Please wait 5 minutes."})}static async check2FAAttempts(e){return new a().checkRateLimit(`2fa:${e}`,{windowMs:6e5,maxAttempts:5,message:"Too many 2FA attempts. Please wait 10 minutes."})}static async checkSMSAttempts(e){return new a().checkRateLimit(`sms:${e}`,{windowMs:36e5,maxAttempts:3,message:"Too many SMS requests. Please wait 1 hour."})}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[372,657,296,390,472],()=>i(6797));module.exports=r})();