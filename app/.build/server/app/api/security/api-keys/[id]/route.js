"use strict";(()=>{var e={};e.id=442,e.ids=[442],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},32371:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>k,requestAsyncStorage:()=>w,routeModule:()=>y,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var i={};r.r(i),r.d(i,{DELETE:()=>h,PUT:()=>m,dynamic:()=>p});var s=r(79182),a=r(72007),n=r(56719),o=r(93442),c=r(57978),d=r(11826),l=r(83178),u=r(61901);let p="force-dynamic";async function m(e,{params:t}){try{let r=await (0,c.getServerSession)(d.L);if(!r?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{keyName:i,apiKey:s,isActive:a}=await e.json(),n=await l._.apiKey.findFirst({where:{id:t.id,userId:r.user.id}});if(!n)return o.NextResponse.json({error:"API key not found"},{status:404});let p={};if(void 0!==i&&(p.keyName=i.trim()),void 0!==a&&(p.isActive=a),s){let e=u.$.validateApiKeyFormat(s,n.provider);if(!e.isValid)return o.NextResponse.json({error:e.error},{status:400});p.encryptedKey=u.$.encryptApiKey(s)}let m=await l._.apiKey.update({where:{id:t.id},data:p,select:{id:!0,provider:!0,keyName:!0,isActive:!0,lastUsed:!0,createdAt:!0,updatedAt:!0}});return o.NextResponse.json({message:"API key updated successfully",apiKey:m})}catch(e){return console.error("Update API key error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}async function h(e,{params:t}){try{let e=await (0,c.getServerSession)(d.L);if(!e?.user?.id)return o.NextResponse.json({error:"Unauthorized"},{status:401});let r=await l._.apiKey.deleteMany({where:{id:t.id,userId:e.user.id}});if(0===r.count)return o.NextResponse.json({error:"API key not found"},{status:404});return o.NextResponse.json({message:"API key deleted successfully"})}catch(e){return console.error("Delete API key error:",e),o.NextResponse.json({error:"Internal server error"},{status:500})}}let y=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/security/api-keys/[id]/route",pathname:"/api/security/api-keys/[id]",filename:"route",bundlePath:"app/api/security/api-keys/[id]/route"},resolvedPagePath:"/home/ubuntu/naggery_app/app/app/api/security/api-keys/[id]/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:w,staticGenerationAsyncStorage:g,serverHooks:f}=y,A="/api/security/api-keys/[id]/route";function k(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},11826:(e,t,r)=>{r.d(t,{L:()=>d});var i=r(66291),s=r(64617),a=r(83178),n=r(3390),o=r.n(n),c=r(35229);let d={adapter:(0,s.N)(a._),providers:[(0,i.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"},twoFaCode:{label:"2FA Code",type:"text"},backupCode:{label:"Backup Code",type:"text"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email and password are required");if(!(await c.p.checkLoginAttempts(e.email)).allowed)throw Error("Too many login attempts. Please try again later.");let t=await a._.user.findUnique({where:{email:e.email}});if(!t)throw Error("Invalid email or password");if(t.lockedUntil&&t.lockedUntil>new Date){let e=Math.ceil((t.lockedUntil.getTime()-Date.now())/6e4);throw Error(`Account is locked. Try again in ${e} minutes.`)}if(!await o().compare(e.password,t.password))throw await a._.user.update({where:{id:t.id},data:{loginAttempts:t.loginAttempts+1,lockedUntil:t.loginAttempts>=4?new Date(Date.now()+9e5):null}}),Error("Invalid email or password");if(!t.emailVerified)throw Error("Please verify your email address before logging in. Check your inbox for the verification link.");if(!t.isActive)throw Error("Your account is not active. Please contact support.");if(t.twoFaEnabled){let{twoFaCode:r,backupCode:i}=e;if(!r&&!i)return{id:t.id,email:t.email,name:t.name,phone:t.phone,emailVerified:!!t.emailVerified,phoneVerified:!!t.phoneVerified,twoFaEnabled:t.twoFaEnabled,isActive:t.isActive,requiresTwoFa:!0}}return t.loginAttempts>0&&await a._.user.update({where:{id:t.id},data:{loginAttempts:0,lockedUntil:null}}),{id:t.id,email:t.email,name:t.name,phone:t.phone,emailVerified:!!t.emailVerified,phoneVerified:!!t.phoneVerified,twoFaEnabled:t.twoFaEnabled,isActive:t.isActive,requiresTwoFa:!1}}})],session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/login"},callbacks:{jwt:async({token:e,user:t,trigger:r,session:i})=>(t&&(e.id=t.id,e.emailVerified=!!t.emailVerified,e.phoneVerified=!!t.phoneVerified,e.twoFaEnabled=!!t.twoFaEnabled,e.isActive=!!t.isActive,e.requiresTwoFa=!!t.requiresTwoFa),"update"===r&&i&&(e={...e,...i}),e),session:async({session:e,token:t})=>(t&&e.user&&(e.user.id=t.id,e.user.emailVerified=!!t.emailVerified,e.user.phoneVerified=!!t.phoneVerified,e.user.twoFaEnabled=!!t.twoFaEnabled,e.user.isActive=!!t.isActive,e.user.requiresTwoFa=!!t.requiresTwoFa),e)},events:{async signIn({user:e,account:t,profile:r,isNewUser:i}){console.log("User signed in:",{userId:e.id,email:e.email,isNewUser:i})},async signOut({session:e,token:t}){console.log("User signed out:",{userId:t?.id})}}}},83178:(e,t,r)=>{r.d(t,{_:()=>s});var i=r(53524);let s=globalThis.prisma??new i.PrismaClient},61901:(e,t,r)=>{r.d(t,{$:()=>o});var i=r(84770),s=r.n(i),a=r(80238),n=r.n(a);class o{static{this.ENCRYPTION_KEY=process.env.ENCRYPTION_KEY||"default-key-change-in-production"}static{this.ALGORITHM="aes-256-gcm"}static generateRandomString(e=32){return s().randomBytes(e).toString("hex")}static hashPassword(e){let t=s().randomBytes(16).toString("hex"),r=s().pbkdf2Sync(e,t,1e4,64,"sha512").toString("hex");return`${t}:${r}`}static verifyPassword(e,t){let[r,i]=t.split(":");return i===s().pbkdf2Sync(e,r,1e4,64,"sha512").toString("hex")}static encryptData(e){try{return n().AES.encrypt(e,this.ENCRYPTION_KEY).toString()}catch(e){throw console.error("Encryption error:",e),Error("Failed to encrypt data")}}static decryptData(e){try{return n().AES.decrypt(e,this.ENCRYPTION_KEY).toString(n().enc.Utf8)}catch(e){throw console.error("Decryption error:",e),Error("Failed to decrypt data")}}static generateSecureToken(e=64){return s().randomBytes(e).toString("base64url")}static createSecureHash(e){return s().createHash("sha256").update(e).digest("hex")}static isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}static isValidPhone(e){return/^\+[1-9]\d{1,14}$/.test(e)}static sanitizePhone(e){return e.replace(/[^\d+]/g,"")}static formatPhone(e){let t=this.sanitizePhone(e);return t.startsWith("+")?t:`+1${t}`}static isPasswordStrong(e){let t=[];return e.length<8&&t.push("Password must be at least 8 characters long"),/[A-Z]/.test(e)||t.push("Password must contain at least one uppercase letter"),/[a-z]/.test(e)||t.push("Password must contain at least one lowercase letter"),/\d/.test(e)||t.push("Password must contain at least one number"),/[!@#$%^&*(),.?":{}|<>]/.test(e)||t.push("Password must contain at least one special character"),{isStrong:0===t.length,errors:t}}static encryptApiKey(e){if(!e||""===e.trim())throw Error("API key cannot be empty");return this.encryptData(e.trim())}static decryptApiKey(e){if(!e||""===e.trim())throw Error("Encrypted API key cannot be empty");return this.decryptData(e.trim())}static validateApiKeyFormat(e,t){if(!e||""===e.trim())return{isValid:!1,error:"API key cannot be empty"};let r=e.trim();switch(t){case"OPENAI":if(!r.startsWith("sk-"))return{isValid:!1,error:'OpenAI API keys must start with "sk-"'};if(r.length<20)return{isValid:!1,error:"OpenAI API key appears to be too short"};break;case"CLAUDE":if(!r.startsWith("sk-ant-"))return{isValid:!1,error:'Claude API keys must start with "sk-ant-"'};if(r.length<20)return{isValid:!1,error:"Claude API key appears to be too short"};break;default:return{isValid:!1,error:"Unsupported API provider"}}return{isValid:!0}}static maskApiKey(e){if(!e||e.length<8)return"****";let t=e.substring(0,4),r=e.substring(e.length-4),i="*".repeat(Math.max(4,e.length-8));return`${t}${i}${r}`}}},35229:(e,t,r)=>{r.d(t,{p:()=>a});var i=r(39103),s=r.n(i);class a{constructor(){this.defaultOptions={windowMs:9e5,maxAttempts:5,message:"Too many attempts, please try again later"},this.cache=new(s())({stdTTL:this.defaultOptions.windowMs/1e3,checkperiod:60})}async checkRateLimit(e,t={}){let r={...this.defaultOptions,...t},i=`rate_limit:${e}`,s=Date.now();r.windowMs;let a=this.cache.get(i)||{count:0,resetTime:s+r.windowMs};s>a.resetTime&&(a={count:0,resetTime:s+r.windowMs}),a.count++;let n=Math.ceil((a.resetTime-s)/1e3);this.cache.set(i,a,n);let o=a.count<=r.maxAttempts;return{allowed:o,remaining:Math.max(0,r.maxAttempts-a.count),resetTime:a.resetTime,message:o?void 0:r.message}}async incrementAttempt(e){await this.checkRateLimit(e)}async resetRateLimit(e){let t=`rate_limit:${e}`;this.cache.del(t)}static async checkLoginAttempts(e){return new a().checkRateLimit(`login:${e}`,{windowMs:9e5,maxAttempts:5,message:"Too many login attempts. Please try again in 15 minutes."})}static async checkVerificationAttempts(e){return new a().checkRateLimit(`verification:${e}`,{windowMs:3e5,maxAttempts:3,message:"Too many verification attempts. Please wait 5 minutes."})}static async check2FAAttempts(e){return new a().checkRateLimit(`2fa:${e}`,{windowMs:6e5,maxAttempts:5,message:"Too many 2FA attempts. Please wait 10 minutes."})}static async checkSMSAttempts(e){return new a().checkRateLimit(`sms:${e}`,{windowMs:36e5,maxAttempts:3,message:"Too many SMS requests. Please wait 1 hour."})}}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[372,609,103,390,472,238],()=>r(32371));module.exports=i})();