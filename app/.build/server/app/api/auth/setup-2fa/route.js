"use strict";(()=>{var e={};e.id=326,e.ids=[326],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},80490:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>F,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>A,staticGenerationAsyncStorage:()=>x});var a={};r.r(a),r.d(a,{DELETE:()=>f,GET:()=>w,POST:()=>h,dynamic:()=>m});var s=r(79182),i=r(72007),o=r(56719),n=r(93442),u=r(57978),d=r(11826),c=r(83178),l=r(7546),p=r(35229);let m="force-dynamic";async function w(e){try{let e=await (0,u.getServerSession)(d.L);if(!e?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let t=await p.p.check2FAAttempts(e.user.id);if(!t.allowed)return n.NextResponse.json({error:t.message},{status:429});let r=await c._.user.findUnique({where:{id:e.user.id}});if(!r)return n.NextResponse.json({error:"User not found"},{status:404});if(r.twoFaEnabled)return n.NextResponse.json({error:"2FA is already enabled"},{status:400});let a=l.I.generateSecret(),s=await l.I.generateQRCode(a,r.email,"Naggery"),i=l.I.generateBackupCodes();return await c._.user.update({where:{id:r.id},data:{twoFaSecret:a}}),await c._.backupCode.deleteMany({where:{userId:r.id}}),await c._.backupCode.createMany({data:i.map(e=>({userId:r.id,code:e}))}),n.NextResponse.json({secret:a,qrCodeUrl:s,backupCodes:i,message:"Scan the QR code with your authenticator app, then verify with a code to enable 2FA"},{status:200})}catch(e){return console.error("2FA setup error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function h(e){try{let t=await (0,u.getServerSession)(d.L);if(!t?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{code:r}=await e.json();if(!r)return n.NextResponse.json({error:"Verification code is required"},{status:400});let a=await p.p.check2FAAttempts(t.user.id);if(!a.allowed)return n.NextResponse.json({error:a.message},{status:429});let s=await c._.user.findUnique({where:{id:t.user.id}});if(!s||!s.twoFaSecret)return n.NextResponse.json({error:"No 2FA setup found. Please start the setup process first."},{status:400});if(s.twoFaEnabled)return n.NextResponse.json({error:"2FA is already enabled"},{status:400});if(!l.I.verifyToken(r,s.twoFaSecret))return n.NextResponse.json({error:"Invalid verification code"},{status:400});return await c._.user.update({where:{id:s.id},data:{twoFaEnabled:!0}}),n.NextResponse.json({success:!0,message:"2FA enabled successfully! Your account is now more secure."},{status:200})}catch(e){return console.error("2FA verification error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function f(e){try{let t=await (0,u.getServerSession)(d.L);if(!t?.user?.id)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{code:r,backupCode:a}=await e.json();if(!r&&!a)return n.NextResponse.json({error:"2FA code or backup code is required"},{status:400});let s=await c._.user.findUnique({where:{id:t.user.id},include:{backupCodes:!0}});if(!s||!s.twoFaEnabled)return n.NextResponse.json({error:"2FA is not enabled"},{status:400});let i=!1;if(r&&s.twoFaSecret)i=l.I.verifyToken(r,s.twoFaSecret);else if(a){let e=s.backupCodes.find(e=>e.code===a.toUpperCase()&&!e.used);e&&(i=!0,await c._.backupCode.update({where:{id:e.id},data:{used:!0,usedAt:new Date}}))}if(!i)return n.NextResponse.json({error:"Invalid verification code or backup code"},{status:400});return await c._.user.update({where:{id:s.id},data:{twoFaEnabled:!1,twoFaSecret:null}}),await c._.backupCode.deleteMany({where:{userId:s.id}}),n.NextResponse.json({success:!0,message:"2FA disabled successfully"},{status:200})}catch(e){return console.error("2FA disable error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/setup-2fa/route",pathname:"/api/auth/setup-2fa",filename:"route",bundlePath:"app/api/auth/setup-2fa/route"},resolvedPagePath:"/home/ubuntu/naggery_app/app/app/api/auth/setup-2fa/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:A}=g,v="/api/auth/setup-2fa/route";function F(){return(0,o.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:x})}},11826:(e,t,r)=>{r.d(t,{L:()=>d});var a=r(66291),s=r(64617),i=r(83178),o=r(3390),n=r.n(o),u=r(35229);let d={adapter:(0,s.N)(i._),providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"},twoFaCode:{label:"2FA Code",type:"text"},backupCode:{label:"Backup Code",type:"text"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email and password are required");if(!(await u.p.checkLoginAttempts(e.email)).allowed)throw Error("Too many login attempts. Please try again later.");let t=await i._.user.findUnique({where:{email:e.email}});if(!t)throw Error("Invalid email or password");if(t.lockedUntil&&t.lockedUntil>new Date){let e=Math.ceil((t.lockedUntil.getTime()-Date.now())/6e4);throw Error(`Account is locked. Try again in ${e} minutes.`)}if(!await n().compare(e.password,t.password))throw await i._.user.update({where:{id:t.id},data:{loginAttempts:t.loginAttempts+1,lockedUntil:t.loginAttempts>=4?new Date(Date.now()+9e5):null}}),Error("Invalid email or password");if(!t.emailVerified)throw Error("Please verify your email address before logging in. Check your inbox for the verification link.");if(!t.isActive)throw Error("Your account is not active. Please contact support.");if(t.twoFaEnabled){let{twoFaCode:r,backupCode:a}=e;if(!r&&!a)return{id:t.id,email:t.email,name:t.name,phone:t.phone,emailVerified:!!t.emailVerified,phoneVerified:!!t.phoneVerified,twoFaEnabled:t.twoFaEnabled,isActive:t.isActive,requiresTwoFa:!0}}return t.loginAttempts>0&&await i._.user.update({where:{id:t.id},data:{loginAttempts:0,lockedUntil:null}}),{id:t.id,email:t.email,name:t.name,phone:t.phone,emailVerified:!!t.emailVerified,phoneVerified:!!t.phoneVerified,twoFaEnabled:t.twoFaEnabled,isActive:t.isActive,requiresTwoFa:!1}}})],session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/login"},callbacks:{jwt:async({token:e,user:t,trigger:r,session:a})=>(t&&(e.id=t.id,e.emailVerified=!!t.emailVerified,e.phoneVerified=!!t.phoneVerified,e.twoFaEnabled=!!t.twoFaEnabled,e.isActive=!!t.isActive,e.requiresTwoFa=!!t.requiresTwoFa),"update"===r&&a&&(e={...e,...a}),e),session:async({session:e,token:t})=>(t&&e.user&&(e.user.id=t.id,e.user.emailVerified=!!t.emailVerified,e.user.phoneVerified=!!t.phoneVerified,e.user.twoFaEnabled=!!t.twoFaEnabled,e.user.isActive=!!t.isActive,e.user.requiresTwoFa=!!t.requiresTwoFa),e)},events:{async signIn({user:e,account:t,profile:r,isNewUser:a}){console.log("User signed in:",{userId:e.id,email:e.email,isNewUser:a})},async signOut({session:e,token:t}){console.log("User signed out:",{userId:t?.id})}}}},83178:(e,t,r)=>{r.d(t,{_:()=>s});var a=r(53524);let s=globalThis.prisma??new a.PrismaClient},35229:(e,t,r)=>{r.d(t,{p:()=>i});var a=r(39103),s=r.n(a);class i{constructor(){this.defaultOptions={windowMs:9e5,maxAttempts:5,message:"Too many attempts, please try again later"},this.cache=new(s())({stdTTL:this.defaultOptions.windowMs/1e3,checkperiod:60})}async checkRateLimit(e,t={}){let r={...this.defaultOptions,...t},a=`rate_limit:${e}`,s=Date.now();r.windowMs;let i=this.cache.get(a)||{count:0,resetTime:s+r.windowMs};s>i.resetTime&&(i={count:0,resetTime:s+r.windowMs}),i.count++;let o=Math.ceil((i.resetTime-s)/1e3);this.cache.set(a,i,o);let n=i.count<=r.maxAttempts;return{allowed:n,remaining:Math.max(0,r.maxAttempts-i.count),resetTime:i.resetTime,message:n?void 0:r.message}}async incrementAttempt(e){await this.checkRateLimit(e)}async resetRateLimit(e){let t=`rate_limit:${e}`;this.cache.del(t)}static async checkLoginAttempts(e){return new i().checkRateLimit(`login:${e}`,{windowMs:9e5,maxAttempts:5,message:"Too many login attempts. Please try again in 15 minutes."})}static async checkVerificationAttempts(e){return new i().checkRateLimit(`verification:${e}`,{windowMs:3e5,maxAttempts:3,message:"Too many verification attempts. Please wait 5 minutes."})}static async check2FAAttempts(e){return new i().checkRateLimit(`2fa:${e}`,{windowMs:6e5,maxAttempts:5,message:"Too many 2FA attempts. Please wait 10 minutes."})}static async checkSMSAttempts(e){return new i().checkRateLimit(`sms:${e}`,{windowMs:36e5,maxAttempts:3,message:"Too many SMS requests. Please wait 1 hour."})}}},7546:(e,t,r)=>{r.d(t,{I:()=>n});var a=r(96194),s=r(95938),i=r(84770),o=r.n(i);class n{static generateSecret(){return a.authenticator.generateSecret()}static async generateQRCode(e,t,r="Naggery"){let i=a.authenticator.keyuri(t,r,e);return s.toDataURL(i)}static verifyToken(e,t){try{return a.authenticator.verify({token:e,secret:t})}catch(e){return console.error("2FA verification error:",e),!1}}static generateBackupCodes(e=10){let t=[];for(let r=0;r<e;r++){let e=o().randomBytes(4).toString("hex").toUpperCase();t.push(e)}return t}static validateBackupCode(e){return/^[A-F0-9]{8}$/.test(e.toUpperCase())}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[372,609,103,390,472,637],()=>r(80490));module.exports=a})();